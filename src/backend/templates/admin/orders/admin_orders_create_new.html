{% extends "base.html" %}

{% block title %}–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<div class="navigation-panel">
    <a href="{{ url_for('admin.orders') }}" class="button">–ù–∞–∑–∞–¥</a>
    <a href="{{ url_for('admin.create_customer') }}" class="button highlight">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑—á–∏–∫–∞</a>
    <a href="{{ url_for('admin.customers') }}" class="button">–ó–∞–∫–∞–∑—á–∏–∫–∏</a>
</div>

<main>
    <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞</h2>

    <!-- –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑—á–∏–∫–∞ -->
    <div class="search-bar">
        üîç <label for="searchCustomers">–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞:</label>
        <input type="text" id="searchCustomers" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞..." autocomplete="off">
        <ul id="customerDropdown" class="dropdown-menu"></ul>
    </div>

    <form id="createOrderForm" method="POST" action="{{ url_for('admin.create_order') }}">
        <input type="hidden" id="customer_id" name="customer_id">

        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <th>–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞</th>
                <td>
                    <input type="text" id="customer_name" name="customer_name" style="width: 100%;" readonly required>
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–¢–µ–ª–µ—Ñ–æ–Ω –∑–∞–∫–∞–∑—á–∏–∫–∞</th>
                <td>
                    <input type="text" id="customer_phone" name="customer_phone" style="width: 100%;" readonly required>
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–ê–¥—Ä–µ—Å –∑–∞–∫–∞–∑—á–∏–∫–∞</th>
                <td>
                    <input type="text" id="customer_address" name="customer_address" style="width: 100%;" readonly required>
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</th>
                <td>
                    <input type="text" id="short_description" name="short_description" style="width: 100%;" required>
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</th>
                <td>
                    <textarea id="description" name="description" rows="4" style="width: 100%;" required></textarea>
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ / –°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                <td>
                    <input type="date" id="deadline_at" name="deadline_at" style="width: 48%;" required>
                    <input type="number" id="price" name="price" step="0.01" style="width: 48%;" required placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å">
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</th>
                <td class="checkbox-container">
                    <label>
                        <input type="checkbox" id="send_executor" name="send_executor" value="1" checked>
                        <span>–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫</span>
                    </label>
                    <label>
                        <input type="checkbox" id="send_specialist" name="send_specialist" value="1">
                        <span>–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</span>
                    </label>
                </td>
            </tr>
        </table>

        <div style="text-align: center; margin-top: 20px;">
            <button type="submit" class="button">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </form>
</main>

<!-- –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchCustomers");
    const dropdown = document.getElementById("customerDropdown");
    const customerIdInput = document.getElementById("customer_id");
    const customerNameInput = document.getElementById("customer_name");
    const phoneInput = document.getElementById("customer_phone");
    const addressInput = document.getElementById("customer_address");

    let customers = {{ customers | tojson }};  // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑—á–∏–∫–æ–≤ –∏–∑ Python

    function updateDropdown(filteredCustomers) {
        dropdown.innerHTML = "";
        if (filteredCustomers.length === 0) {
            dropdown.style.display = "none";
            return;
        }

        dropdown.style.display = "block";
        filteredCustomers.forEach(customer => {
            let item = document.createElement("li");
            item.textContent = `${customer.name} (${customer.email || "–Ω–µ—Ç email"})`;
            item.dataset.id = customer.id;
            item.dataset.phone = customer.phone || "";
            item.dataset.address = customer.address || "";
            item.addEventListener("click", function () {
                customerIdInput.value = this.dataset.id;
                customerNameInput.value = this.textContent;
                phoneInput.value = this.dataset.phone;
                addressInput.value = this.dataset.address;
                dropdown.style.display = "none";
            });
            dropdown.appendChild(item);
        });
    }

    searchInput.addEventListener("input", function () {
        let query = searchInput.value.toLowerCase();
        let filteredCustomers = customers.filter(customer =>
            customer.name.toLowerCase().includes(query) || (customer.email || "").toLowerCase().includes(query)
        );
        updateDropdown(filteredCustomers);
    });

    document.addEventListener("click", function (event) {
        if (!dropdown.contains(event.target) && event.target !== searchInput) {
            dropdown.style.display = "none";
        }
    });
});
</script>

<style>
.dropdown-menu {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 200px;
    overflow-y: auto;
    width: 300px;
    display: none;
}
.dropdown-menu li {
    padding: 5px;
    cursor: pointer;
}
.dropdown-menu li:hover {
    background: #ddd;
}
</style>

{% endblock %}
