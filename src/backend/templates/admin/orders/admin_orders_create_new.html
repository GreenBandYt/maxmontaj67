{% extends "base.html" %}

{% block title %}–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<div class="navigation-panel">
    <a href="{{ url_for('admin.orders') }}" class="button">–ù–∞–∑–∞–¥</a>
    <a href="{{ url_for('admin.create_customer') }}" class="button highlight">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑—á–∏–∫–∞</a>
    <a href="{{ url_for('admin.customers') }}" class="button">–ó–∞–∫–∞–∑—á–∏–∫–∏</a>
</div>

<main>
    <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞</h2>

    <!-- –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑—á–∏–∫–∞ -->
    <div class="search-bar">
        üîç <label for="searchCustomers">–ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—á–∏–∫–∞:</label>
        <input type="text" id="searchCustomers" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ email...">
        <button type="button" id="clearSearch">‚ùå</button>
    </div>

    <form id="createOrderForm" method="POST" action="{{ url_for('admin.create_order') }}">
        <table style="width: 100%; border-collapse: collapse;">
            <colgroup>
                <col style="width: 20%;">
                <col style="width: 80%;">
            </colgroup>

            <tr>
                <th>–ò–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞</th>
                <td>
                    <select id="customer_id" name="customer_id" style="width: 100%;" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑—á–∏–∫–∞...</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}" data-phone="{{ customer.phone }}" data-address="{{ customer.address }}">
                            {{ customer.name }} ({{ customer.email }})
                        </option>
                        {% endfor %}
                    </select>
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–¢–µ–ª–µ—Ñ–æ–Ω –∑–∞–∫–∞–∑—á–∏–∫–∞</th>
                <td>
                    <input type="text" id="customer_phone" name="customer_phone" style="width: 100%;" required>
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–ê–¥—Ä–µ—Å –∑–∞–∫–∞–∑—á–∏–∫–∞</th>
                <td>
                    <input type="text" id="customer_address" name="customer_address" style="width: 100%;" required>
                    <span class="error-message"></span>
                </td>
            </tr>

            <tr>
                <th>–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</th>
                <td>
                    <input type="text" id="short_description" name="short_description" style="width: 100%;" required>
                    <span class="error-message"></span>
                </td>
            </tr>
            <tr>
                <th>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</th>
                <td>
                    <textarea id="description" name="description" rows="4" style="width: 100%;" required></textarea>
                    <span class="error-message"></span>
                </td>
            </tr>

            <tr>
                <th>–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ / –°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                <td>
                    <input type="date" id="deadline_at" name="deadline_at" style="width: 48%;" required>
                    <input type="number" id="price" name="price" step="0.01" style="width: 48%;" required placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å">
                    <span class="error-message"></span>
                </td>
            </tr>

            <tr>
                <th>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</th>
                <td class="checkbox-container">
                    <label>
                        <input type="checkbox" id="send_executor" name="send_executor" value="1" checked>
                        <span>–ú–æ–Ω—Ç–∞–∂–Ω–∏–∫</span>
                    </label>
                    <label>
                        <input type="checkbox" id="send_specialist" name="send_specialist" value="1">
                        <span>–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</span>
                    </label>
                </td>
            </tr>

        </table>

        <div style="text-align: center; margin-top: 20px;">
            <button type="submit" class="button">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </form>
</main>

<!-- –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑—á–∏–∫–∞ –∏ —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ–∏—Å–∫ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const customerSelect = document.getElementById("customer_id");
    const searchInput = document.getElementById("searchCustomers");
    const clearButton = document.getElementById("clearSearch");
    const phoneInput = document.getElementById("customer_phone");
    const addressInput = document.getElementById("customer_address");

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—á–∏–∫–æ–≤
    let originalCustomers = Array.from(customerSelect.options);

    function filterCustomers() {
        let filter = searchInput.value.toLowerCase();

        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫, –æ—Å—Ç–∞–≤–ª—è—è –ø–µ—Ä–≤—É—é –æ–ø—Ü–∏—é "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑—á–∏–∫–∞..."
        customerSelect.innerHTML = "";
        customerSelect.appendChild(originalCustomers[0]); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É

        let found = false;

        originalCustomers.slice(1).forEach(option => {
            if (option.textContent.toLowerCase().includes(filter)) {
                customerSelect.appendChild(option);
                if (!found) {
                    customerSelect.value = option.value;
                    found = true;
                }
            }
        });

        // –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
        if (!found) {
            customerSelect.value = "";
        }
    }

    function clearCustomerSearch() {
        searchInput.value = "";
        customerSelect.innerHTML = "";
        originalCustomers.forEach(option => customerSelect.appendChild(option));
        customerSelect.value = "";
    }

    function updateCustomerDetails() {
        let selectedOption = customerSelect.options[customerSelect.selectedIndex];
        phoneInput.value = selectedOption.dataset.phone || "";
        addressInput.value = selectedOption.dataset.address || "";
    }

    searchInput.addEventListener("input", filterCustomers);
    clearButton.addEventListener("click", clearCustomerSearch);
    customerSelect.addEventListener("change", updateCustomerDetails);
});
</script>

{% endblock %}
